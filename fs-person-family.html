<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fs-behavior/fs-behavior.html">
<link rel="import" href="../fs-client/fs-client.html">
<link rel="import" href="../fs-family/fs-family.html">

<!--
Display a FamilySearch person's family.

Basic example:

    <fs-person-family person-id="PPP-PPPP"></fs-person-family>

@group FamilySearch Elements
@element fs-person-family
@demo demo/index.html
-->
<dom-module id="fs-person-family">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
      }
      
      paper-card {
        width: 100%;
      }
      
      #columns {
        display: flex;
      }
      
      .column {
        flex-grow: 1;
      }
      
      fs-family {
        margin-top: 16px;
      }
    </style>
    <fs-client name="[[clientName]]" on-authenticated-changed="_loadFamily"></fs-client>
    <div class="card-content">
      <div id="columns">
        <div class="column">
          <div class="col-title">Spouses and Children</div>
          <div>
            <template is="dom-repeat" items="{{_spouseUrls}}">
              <fs-family client-name="[[clientName]]" couple-url="{{item}}" include-children></fs-family>
            </template>
          </div>
        </div>
        <div class="column">
          <div class="col-title">Parents and Siblings</div>
          <div>
            <template is="dom-repeat" items="{{_parentIds}}">
              <fs-family client-name="[[clientName]]" husband-id="{{item.husbandId}}" wife-id="{{item.wifeId}}" include-children></fs-family>
            </template>
          </div>
        </div>
      </div>
    </div>
  </template>
</dom-module>

<script>

  Polymer({

    is: 'fs-person-family',
    
    properties: {
      
      personId: {
        type: String,
        observer: '_personIdChanged'
      },
      
      requested: {
        type: Boolean,
        readOnly: true,
        value: false
      },
      
      _familyResponse: {
        type: Object,
        readOnly: true,
        value: null,
        observer: '_displayFamily'
      },
      
      _spouseUrls: {
        type: Array,
        value: function(){
          return [];
        }
      },
      
      _parentIds: {
        type: Array,
        value: function(){
          return [];
        }
      }
      
    },

    behaviors: [FSBehavior],
    
    _authChanged: function(event){
      this._loadFamily();
    },
    
    _personIdChanged: function(){
      if(this.personId){
        this._loadFamily();
      } else {
        this._setRequested(false);
        this._spouseUrls = [];
        this._parentIds = [];
        this._set_familyResponse(null);
      }
    },
    
    _loadFamily: function(){
      var self = this;
      if(this.isAuthenticated() && this.personId && !this.requested){
        this._setRequested(true);
        this.getClient().getPersonWithRelationships(this.personId).then(function(response){
          self._set_familyResponse(response);
        });
      }
    },
    
    _displayFamily: function(){
      if(this._familyResponse){
        
        // Spouses and children
        var spouseRels = this._familyResponse.getSpouseRelationships();
        for(var i = 0; i < spouseRels.length; i++){
          this.push('_spouseUrls', spouseRels[i].getCoupleUrl());
        }
        
        // Parents and siblings
        var parentRels = this._familyResponse.getParentRelationships();
        for(var i = 0; i < parentRels.length; i++){
          var rel = parentRels[i];
          this.push('_parentIds', {
            husbandId: rel.getFatherId(),
            wifeId: rel.getMotherId()
          });
        }
      }
    }
    
  });

</script>
